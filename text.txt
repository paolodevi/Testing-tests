k = 2;

% ---------- 1) Build list of candidate (i,j) pairs to review ----------
[idx_i, idx_j] = find(groups(k).candidates == 1);
nCandidates = numel(idx_i);

if nCandidates == 0
    disp('No candidates to review.');
else
    % Prepare containers
    responses = nan(nCandidates,1); % 1 = accept, 0 = reject, NaN = no decision/closed

    % ---------- 2) Iterate the candidate list and show animations ----------
    for m = 1:nCandidates
        i = idx_i(m);
        j = idx_j(m);

        % find frames1
        frames1 = [];
        for ii = 1:size(files_ref,1)
            ref_str = strrep(num2str(round(groups(k).fr(i),2)), '.', '_');
            if contains(files_ref(ii).name, ref_str)
                load(fullfile(files_ref(ii).folder, files_ref(ii).name)); %#ok<LOAD>
                frames1 = frames;
                break;
            end
        end

        % find frames2
        frames2 = [];
        for ii = 1:size(files_tgt,1)
            tgt_str = strrep(num2str(round(groups(k).ft(j),2)), '.', '_');
            if contains(files_tgt(ii).name, tgt_str)
                load(fullfile(files_tgt(ii).folder, files_tgt(ii).name)); %#ok<LOAD>
                frames2 = frames;
                break;
            end
        end

        if isempty(frames1) || isempty(frames2)
            warning('Missing frames for candidate (%d,%d). Skipping...', i, j);
            responses(m) = NaN;
            continue;
        end

        % Play the animation and wait for user's button press
        responses(m) = playTwoAnimations(frames1, frames2, 30);
        % responses(m) is 1 (accept), 0 (reject) or NaN/empty if closed without answer
    end

    % ---------- 3) Apply responses to groups(k).candidates (outside i/j loops) ----------
    % Note: apply accepts first, then rejects. If multiple accepts exist on same row,
    % the last processed accept will set that (i,j) to 1 and zero the row.
    for m = 1:nCandidates
        i = idx_i(m);
        j = idx_j(m);
        r = responses(m);

        if isnan(r)
            % do nothing (or handle as desired)
            continue;
        end

        if r == 1
            % Accept: zero whole row, then keep this one entry
            groups(k).candidates(i, :) = 0;
            groups(k).candidates(i, j) = 1;
        elseif r == 0
            % Reject: set this entry to zero
            groups(k).candidates(i, j) = 0;
        end
    end

    disp('Review finished. groups(k).candidates updated.');
end